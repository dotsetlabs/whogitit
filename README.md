# ai-blame

A Rust CLI tool that tracks AI-generated code at line-level granularity, stores prompts alongside commits, and enables developers to distinguish human-written code from AI-generated code during code review.

## Features

- **Line-level AI attribution**: Track exactly which lines were generated by AI, modified by humans, or unchanged
- **Three-way diff analysis**: Accurately attributes code even when you edit AI-generated code before committing
- **Prompt preservation**: Store the prompts that generated code alongside commits
- **Git-native storage**: Uses git notes for portable, push/fetch-friendly storage
- **Claude Code integration**: Automatic capture via hooks
- **GitHub Action**: Automatic PR comments with attribution summaries
- **Privacy protection**: Automatic redaction of sensitive data in prompts

## Quick Start

### 1. Install ai-blame

```bash
# From crates.io (when published)
cargo install ai-blame

# Or from source
git clone https://github.com/dotsetlabs/ai-blame
cd ai-blame
cargo install --path .
```

### 2. Initialize in your repository

```bash
cd your-project
ai-blame init
```

This installs the post-commit hook that attaches attribution data to commits.

### 3. Configure Claude Code hooks

Add to `~/.claude/settings.json`:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "AI_BLAME_HOOK_PHASE=pre ~/.claude/hooks/ai-blame-capture.sh"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "AI_BLAME_HOOK_PHASE=post ~/.claude/hooks/ai-blame-capture.sh"
          }
        ]
      }
    ]
  }
}
```

Create the hook script at `~/.claude/hooks/ai-blame-capture.sh`:

```bash
#!/bin/bash
# See docs/claude-hook.sh for full implementation
```

### 4. Push git notes with your commits

Configure git to push notes:

```bash
git config --add remote.origin.push 'refs/notes/ai-blame'
git config --add remote.origin.fetch '+refs/notes/ai-blame:refs/notes/ai-blame'
```

Then push notes after committing:

```bash
git push origin main
git push origin refs/notes/ai-blame
```

## CLI Commands

### `ai-blame blame <file>`

Show AI attribution for each line of a file:

```bash
ai-blame blame src/main.rs
```

Output:
```
 LINE   â”‚ COMMIT  â”‚ AUTHOR     â”‚ SRC â”‚ CODE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    1   â”‚ a1b2c3d â”‚ Greg King  â”‚  â”€  â”‚ use std::io;
    2   â”‚ d4e5f6g â”‚ Greg King  â”‚  â—  â”‚ use anyhow::Result;
    3   â”‚ d4e5f6g â”‚ Greg King  â”‚  â—  â”‚ use serde::{Deserialize, Serialize};
    4   â”‚ d4e5f6g â”‚ Greg King  â”‚  â—  â”‚ use chrono::Utc;  // modified
    5   â”‚ h8i9j0k â”‚ Greg King  â”‚  +  â”‚ // Added by human
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Legend: â— AI (2) â— AI-modified (1) + Human (1) â”€ Original (1)
AI involvement: 60% (3 of 5 lines)
```

Options:
- `--revision <ref>` - Blame against a specific revision
- `--format json` - Output as JSON
- `--ai-only` - Show only AI-generated lines
- `--human-only` - Show only human-written lines

### `ai-blame show <commit>`

View AI attribution summary for a commit:

```bash
ai-blame show HEAD
```

Output:
```
Commit: d4e5f6g
Session: 7f3a-4b2c-9d1e-8a7b
Model: claude-opus-4-5-20251101
Started: 2026-01-30T14:23:17Z

Prompts used:
  #0: "Add error handling with anyhow..."
  #1: "Implement the serialize trait..."

Files with AI changes:
  src/auth.rs (25 AI, 3 modified, 2 human) - 45 total lines
  src/main.rs (10 AI, 5 original) - 15 total lines

Summary:
  35 AI-generated lines
  3 AI lines modified by human
  2 human-added lines
  5 original/unchanged lines
```

Options:
- `--format json` - Output as JSON for scripting

### `ai-blame prompt <file:line>`

View the prompt that generated specific lines:

```bash
ai-blame prompt src/main.rs:42
```

Output:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  PROMPT #2 in session 7f3a-4b2c-9d1e...                            â•‘
â•‘  Model: claude-opus-4-5-20251101 | 2026-01-30T14:23:17Z            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Add JWT token generation with 24-hour expiration. Use the         â•‘
â•‘  jsonwebtoken crate. The function should take a user_id and        â•‘
â•‘  return a Result<String>.                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Files affected by this prompt:
  - src/auth.rs
  - src/main.rs

File: src/main.rs:42
Commit: d4e5f6g
Source: AI { edit_id: "e1" }
```

### `ai-blame summary`

Generate attribution summary for a range of commits (useful for PRs):

```bash
# Summarize commits from main to HEAD
ai-blame summary --base main --head HEAD

# Output as markdown (for PR comments)
ai-blame summary --base main --format markdown

# Output as JSON
ai-blame summary --format json
```

### `ai-blame status`

Check pending attribution changes:

```bash
ai-blame status
```

Output:
```
Pending AI attribution:
  Session: 7f3a-4b2c-9d1e-8a7b
  Files: 3
  Lines: 45

Run 'git commit' to finalize attribution.
```

### `ai-blame clear`

Clear pending changes without committing:

```bash
ai-blame clear
```

### `ai-blame init`

Initialize ai-blame in a repository:

```bash
ai-blame init
```

This installs the post-commit hook that automatically attaches attribution data.

## GitHub Action

Add AI attribution summaries to your pull requests automatically.

### Quick Setup

Create `.github/workflows/ai-attribution.yml`:

```yaml
name: AI Attribution Summary

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch git notes
        run: git fetch origin refs/notes/ai-blame:refs/notes/ai-blame || true
        continue-on-error: true

      - uses: dotsetlabs/ai-blame/.github/actions/pr-summary@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
```

### PR Comment Example

The action posts a comment like:

```
## ğŸ¤–ğŸ¤– AI Attribution Summary

This PR contains **3** of **5** commits with AI-assisted changes.

### Overview

| Metric | Lines | Percentage |
|--------|------:|----------:|
| ğŸŸ¢ AI-generated | 145 | 58.0% |
| ğŸŸ¡ AI-modified by human | 12 | 4.8% |
| ğŸ”µ Human-added | 43 | 17.2% |
| âšª Original/unchanged | 50 | 20.0% |
| **Total** | **250** | **100%** |

**AI involvement: 62.8%** of changed lines

### Commits with AI Attribution

| Commit | Message | AI | Modified | Human | Files |
|--------|---------|---:|--------:|------:|------:|
| `abc1234` | Add user authentication | 45 | 3 | 10 | 2 |
| `def5678` | Implement JWT tokens | 100 | 9 | 33 | 3 |
```

## How It Works

### Three-Way Diff Analysis

ai-blame uses three-way diff analysis to accurately attribute code:

1. **Original**: Content before any AI edits
2. **AI Snapshots**: Content after each AI edit
3. **Final**: Content at commit time

This allows accurate attribution even when you:
- Modify AI-generated code before committing
- Add your own lines alongside AI code
- Make multiple AI edits to the same file

### Line Sources

Each line is attributed to one of:

| Source | Symbol | Description |
|--------|--------|-------------|
| AI | `â—` | Generated by AI, unchanged |
| AIModified | `â—` | Generated by AI, then edited by human |
| Human | `+` | Added by human after AI edits |
| Original | `â”€` | Existed before AI session, unchanged |
| Unknown | `?` | Could not determine source |

## Data Storage

### Git Notes

Attribution data is stored in `refs/notes/ai-blame` as JSON:

```bash
# View raw attribution data
git notes --ref=ai-blame show HEAD

# List all commits with attribution
git notes --ref=ai-blame list
```

### Pushing Notes

Git notes must be pushed separately:

```bash
# Push notes to remote
git push origin refs/notes/ai-blame

# Or configure automatic pushing
git config --add remote.origin.push 'refs/notes/ai-blame'
```

### Fetching Notes

Configure automatic fetching:

```bash
git config --add remote.origin.fetch '+refs/notes/ai-blame:refs/notes/ai-blame'
```

## Privacy

Prompts are automatically redacted for sensitive data:

- API keys (`api_key`, `apikey`, `api-key`)
- Secrets (`secret`, `token`, `password`)
- AWS credentials (`AKIA...`)
- Private keys (`-----BEGIN.*PRIVATE KEY-----`)
- Bearer tokens (`Bearer ...`)
- GitHub tokens (`ghp_`, `gho_`, `ghs_`)
- Email addresses

Custom patterns can be added (coming soon).

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Claude Code Session                          â”‚
â”‚  User Prompt â†’ AI Response â†’ Edit/Write Tool â†’ File Changes     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ai-blame Capture Hooks                         â”‚
â”‚  PreToolUse: Save file state before edit                        â”‚
â”‚  PostToolUse: Capture change with prompt context                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Pending Buffer                                 â”‚
â”‚  Full content snapshots for three-way analysis                  â”‚
â”‚  Stored in .ai-blame-pending.json                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼ (on git commit)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Three-Way Analysis                             â”‚
â”‚  Compare: Original â†’ AI Snapshots â†’ Final Committed             â”‚
â”‚  Attribute each line to: AI / AIModified / Human / Original     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Git Notes Storage                              â”‚
â”‚  refs/notes/ai-blame â†’ Full attribution JSON per commit         â”‚
â”‚  Includes: prompts, line-level attribution, summaries           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## License

MIT
