# ai-blame

A Rust CLI tool that tracks AI-generated code at line-level granularity, stores prompts alongside commits, and enables developers to distinguish human-written code from AI-generated code during code review.

## Features

- **Line-level AI attribution**: Track exactly which lines were generated by AI
- **Prompt preservation**: Store the prompts that generated code alongside commits
- **Git-native storage**: Uses git notes for portable, push/fetch-friendly storage
- **Claude Code integration**: Hooks into Claude Code for automatic capture
- **Privacy protection**: Automatic redaction of sensitive data in prompts

## Installation

```bash
cargo install --path .
```

## Usage

### Blame a file

Show AI attribution for each line:

```bash
ai-blame blame src/main.rs
```

Output:
```
 LINE │ COMMIT  │ AUTHOR     │ AI │ CODE
──────┼─────────┼────────────┼────┼──────────────────────────────────
    1 │ a1b2c3d │ Greg King  │    │ use bcrypt::{hash, verify};
    2 │ d4e5f6g │ Greg King  │ ●  │ use jsonwebtoken::{encode, decode};
    3 │ d4e5f6g │ Greg King  │ ●  │ use chrono::{Utc, Duration};
────────────────────────────────────────────────────────────────────
Legend: ● AI-generated (2 lines, 67%)
```

Options:
- `--revision <ref>`: Blame against a specific revision
- `--format json`: Output as JSON
- `--ai-only`: Show only AI-generated lines

### View a prompt

See the prompt that generated specific lines:

```bash
ai-blame prompt src/main.rs:42
```

Output:
```
╔══════════════════════════════════════════════════════════════════════╗
║  PROMPT #2 in session 7f3a-4b2c-9d1e                                 ║
║  Model: claude-opus-4-5-20251101 | 2026-01-30 14:23:17              ║
╠══════════════════════════════════════════════════════════════════════╣
║  Add JWT token generation with 24-hour expiration. Use the           ║
║  jsonwebtoken crate.                                                 ║
╚══════════════════════════════════════════════════════════════════════╝
Tool: Edit
File: src/main.rs:42
Commit: d4e5f6g
```

### Show commit attribution

View AI attribution summary for a commit:

```bash
ai-blame show HEAD
```

Output:
```
Commit: d4e5f6g789abc
Session: 7f3a-4b2c-9d1e
Model: claude-opus-4-5-20251101
Started: 2026-01-30T14:23:17Z

Files with AI changes:
  + src/auth.rs  30 lines
  ~ src/main.rs  10 lines

Total: 40 AI-generated lines
Prompts used: 3
```

### Status and management

Check pending changes:
```bash
ai-blame status
```

Clear pending changes:
```bash
ai-blame clear
```

## Claude Code Integration

### Hook Configuration

Add to `~/.claude/settings.json`:

```json
{
  "hooks": {
    "PostToolUse": [{
      "matcher": "Edit|Write",
      "hooks": [{
        "type": "command",
        "command": "ai-blame capture --stdin"
      }]
    }]
  }
}
```

### Post-commit Hook

Create `.git/hooks/post-commit`:

```bash
#!/bin/bash
ai-blame post-commit
```

Make it executable:
```bash
chmod +x .git/hooks/post-commit
```

## Data Storage

### Git Notes

AI attribution is stored in `refs/notes/ai-blame`:

```bash
# View raw attribution data
git notes --ref=ai-blame show HEAD
```

Notes travel with pushes/fetches when configured:
```bash
git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
git config --add remote.origin.push 'refs/notes/*'
```

### Commit Trailers

Commits include AI metadata trailers:
```
AI-Session: abc123-def456
AI-Model: claude-opus-4-5-20251101
AI-Lines: 45
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

## Privacy

Prompts are automatically redacted for:
- API keys and secrets
- Email addresses
- Passwords
- AWS credentials
- Private keys
- Bearer tokens
- GitHub tokens

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Claude Code Session                       │
│  User Prompt → AI Response → Edit/Write Tool → File Changes     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     ai-blame Capture Hook                        │
│  • Intercept file changes                                        │
│  • Capture prompt context                                        │
│  • Compute line-level diffs                                      │
│  • Buffer pending attributions                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (on git commit)
┌─────────────────────────────────────────────────────────────────┐
│                     Git Notes Storage                            │
│  refs/notes/ai-blame → AIAttribution JSON per commit            │
│  Commit trailers: AI-Session, AI-Model, AI-Lines                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     ai-blame CLI                                 │
│  blame: Correlate git blame + AI notes → line-level output      │
│  prompt: Fetch and display prompts for AI-generated lines       │
│  show: Display attribution summary for commits                   │
└─────────────────────────────────────────────────────────────────┘
```

## License

MIT
