# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Status

This is an **unpublished, pre-release package** under active development. There are no external consumers or backward compatibility requirements.

When making changes:
- **Replace, don't deprecate** - Remove old code entirely when implementing new approaches
- **No legacy support needed** - Don't maintain old APIs, patterns, or data formats alongside new ones
- **Refactor freely** - Rename, restructure, and rewrite without compatibility shims
- **Delete unused code** - If something is no longer needed, remove it completely
- **Schema migrations not required** - Update data formats in place; don't version or migrate

The goal is a clean, minimal codebase. Avoid accumulating dead code, `#[deprecated]` markers, or "v1/v2" parallel implementations.

## Build & Test Commands

```bash
# Build
cargo build
cargo build --release

# Run all tests
cargo test --verbose

# Run only unit tests
cargo test --lib

# Run only integration tests
cargo test --test '*'

# Run a single test by name
cargo test test_full_workflow -- --nocapture

# Lint and format
cargo fmt --all -- --check
cargo clippy --all-targets --all-features -- -D warnings

# Security audit
cargo audit
```

## CLI Usage

```bash
# Run locally during development
cargo run -- <command>

# Examples
cargo run -- blame src/main.rs
cargo run -- show HEAD
cargo run -- prompt src/main.rs:42
cargo run -- summary --base main
cargo run -- status
cargo run -- init
```

## Architecture Overview

whogitit tracks AI-generated code at line-level granularity using a dual-hook capture system and three-way diff analysis.

### Data Flow

```
Claude Code Session (Edit/Write tools)
    │
    ├─► PreToolUse Hook: saves file state before edit
    ├─► PostToolUse Hook: captures change + prompt from transcript
    │
    ▼
Pending Buffer (.whogitit-pending.json)
    │   - Full content snapshots (original → AI edit 1 → AI edit 2 → ...)
    │   - Session metadata, prompts, file histories
    │
    ▼ (git commit triggers post-commit hook)
    │
Three-Way Analysis
    │   - Compares: original → AI snapshots → final committed
    │   - Attributes each line: AI / AIModified / Human / Original
    │
    ▼
Git Notes (refs/notes/whogitit)
    - AIAttribution JSON per commit
    - Prompts (redacted), line-level attribution, summaries
```

### Key Modules

- **capture/**: Hook handlers and pending buffer
  - `hook.rs`: CaptureHook - handles PreToolUse/PostToolUse from Claude Code
  - `pending.rs`: PendingBuffer - stores snapshots until commit
  - `threeway.rs`: ThreeWayAnalyzer - core attribution algorithm
  - `snapshot.rs`: Data structures (ContentSnapshot, AIEdit, FileEditHistory, LineAttribution)
  - `diff.rs`: Diff utilities

- **core/**: Attribution data models and blame engine
  - `attribution.rs`: AIAttribution, PromptInfo, SessionMetadata, ModelInfo
  - `blame.rs`: AIBlamer - combines git blame with AI notes

- **storage/**: Git notes persistence
  - `notes.rs`: NotesStore - read/write attribution to `refs/notes/whogitit`
  - `trailers.rs`: TrailerGenerator - git trailers from attribution
  - `audit.rs`: AuditLog, AuditEvent - compliance event logging

- **cli/**: Command implementations
  - `blame.rs`, `show.rs`, `prompt.rs`, `summary.rs` - core commands
  - `export.rs`: Bulk attribution export (JSON/CSV)
  - `retention.rs`: Data retention policy management
  - `audit.rs`: Audit log viewing
  - `redact.rs`: Redaction pattern testing
  - `output.rs`: Formatting (Pretty, JSON, Markdown)

- **privacy/**: Sensitive data protection
  - `redaction.rs`: Redactor - regex patterns for API keys, emails, passwords, etc.
  - `config.rs`: WhogititConfig, PrivacyConfig, RetentionConfig - `.whogitit.toml` parsing

### Line Attribution Types

| Source | Symbol | Description |
|--------|--------|-------------|
| AI | `●` | Generated by AI, unchanged |
| AIModified | `◐` | Generated by AI, then edited by human |
| Human | `+` | Added by human after AI edits |
| Original | `─` | Existed before AI session |
| Unknown | `?` | Could not determine source |

### Data Formats

**Pending Buffer** (`.whogitit-pending.json`): Version 2 format with full content snapshots per file, edit history chain, and session metadata.

**Git Notes** (`refs/notes/whogitit`): AIAttribution JSON with schema version 2, containing session info, prompts array, and per-file line-level attribution results.

## Code Style

- Rust 2021 edition
- Max line width: 100 characters
- 4-space indentation
- Run `cargo fmt` before committing

## Hook Integration

The shell hook at `hooks/whogitit-capture.sh` (installed to `~/.claude/hooks/`) reads the `transcript_path` JSONL file provided by Claude Code to extract user prompts. It uses `jq -s` (slurp mode) since the transcript is JSON Lines format, not a JSON array.
